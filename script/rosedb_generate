#!/usr/bin/env perl

# Automagically generate classes from the schema.
# Possibly only works if the .pm files don't exist yet.

use strict;
use warnings;

BEGIN {
  foreach my $fn (glob("lib/MojoGolf/DB/*/Manager.pm"),
                  glob("lib/MojoGolf/DB/*.pm")) {
    if (-d $fn) {
      rmdir $fn;
      next;
    }
    unlink $fn unless $fn =~ /Object.pm/
  }
}

use lib 'lib';


use MojoGolf::DB;
use Rose::DB::Object::Loader;


my $loader = Rose::DB::Object::Loader->new(
  db => MojoGolf::DB->new(),
  class_prefix => 'MojoGolf::DB',
  base_classes => [qw/MojoGolf::DB::Object/],
  include_views => 1,
);

$loader->make_modules(module_dir => 'lib',
                      # include_views => 1,
                      require_primary_key => 0,  # for site_template_options
                      module_postamble => \&postamble,
                      module_preamble  => "#\n# Automatically generated by $0 on ".scalar(localtime())."\n# --- DO NOT EDIT! ---\n#\n\n",
                      );

sub postamble {
  my $meta    = shift;
  my $manager = shift;

  my $basename = $meta->class;
  $basename =~ s/.*:://;

  $basename .= '/Manager' if ($manager);

  if (-e "lib/MojoGolf/DB/_postamble/$basename") {
    my $postamble = "";
    open my $fh, "<", "lib/MojoGolf/DB/_postamble/$basename" || die "oh no";
    while (<$fh>) {
      $postamble .= $_;
    }
    close $fh;
    return $postamble;
  }

  return "";
}
